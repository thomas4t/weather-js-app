---
- name: Ensure group "docker" exists
  become: true
  group:
    name: docker
    state: present

- name: Add deploy user
  become: true
  user:
    name: "{{ deployUser }}"
    comment: deploy dea middleware
    group: root
    groups: docker
    shell: /bin/bash

# for having sudo without password
- name: Add deploy user to sudoers
  lineinfile:
    path: /etc/sudoers.d/{{deployUser}}
    line: "{{deployUser}} ALL=(ALL) NOPASSWD: ALL"
    state: present
    mode: 0440
    create: yes
    validate: 'visudo -cf %s'

# This is not 100% secure having this in repo, even though that is only the public key
- name: Set authorized key took from file
  authorized_key:
    user: "{{deployUser}}"
    state: present
    key: "{{deployPublicKey}}"

- name: Install docker
  yum: name=docker state=present update_cache=yes
  notify: restart docker

- name: Install docker-compose
  shell: sudo curl -L "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  args:
    warn: no

- name: Install docker-compose - fix permissions
  shell: sudo chmod +x /usr/local/bin/docker-compose
  args:
    warn: no

- name: Install docker-compose - fix path
  lineinfile:
    path: /home/{{deployUser}}/.bashrc
    line: "PATH=$PATH:/usr/local/bin"
    state: present

- name: Alias - docker-compose
  lineinfile:
    path=/home/deploy/.bashrc
    line="alias dc='docker-compose'"
    regexp='^alias dc='docker-compose'$'
    state=present
    insertafter=EOF
    create=True
